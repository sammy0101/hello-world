name: Sync edgetunnel Worker

on:
  schedule:
    - cron: "0 16 * * *" # é¦™æ¸¯æ™‚é–“ 00:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: æª¢å‡ºæ‚¨çš„å€‰åº«
        uses: actions/checkout@v4

      - name: ä¸‹è¼‰æª”æ¡ˆä¸¦è¨­å®šæ™‚é–“æˆ³è¨Šæ¯
        id: check_changes
        run: |
          # --- 1. è¨­å®šè®Šæ•¸èˆ‡æ™‚é–“ ---
          URL_WORKER="https://github.com/cmliu/edgetunnel/raw/refs/heads/main/_worker.js"
          URL_WRANGLER="https://github.com/cmliu/edgetunnel/raw/refs/heads/main/wrangler.toml"
          
          # å–å¾—é¦™æ¸¯æ™‚é–“ (Asia/Hong_Kong)ï¼Œæ ¼å¼ç¯„ä¾‹: 2023-12-09 12:30
          HK_TIME=$(TZ='Asia/Hong_Kong' date +'%Y-%m-%d %H:%M')
          
          # --- 2. ä¸‹è¼‰æª”æ¡ˆ ---
          echo "æ­£åœ¨ä¸‹è¼‰ _worker.js ..."
          curl -L -o "_worker.js" "$URL_WORKER"
          
          echo "æ­£åœ¨ä¸‹è¼‰ wrangler.toml ..."
          curl -L -o "wrangler.toml" "$URL_WRANGLER"

          # --- 3. æª¢æ¸¬è®Šæ›´ ---
          CHANGED_WORKER=$(git status --porcelain _worker.js)
          CHANGED_WRANGLER=$(git status --porcelain wrangler.toml)

          # --- 4. ç”Ÿæˆæäº¤è¨Šæ¯ ---
          if [[ -n "$CHANGED_WORKER" ]] && [[ -n "$CHANGED_WRANGLER" ]]; then
            # å…©å€‹éƒ½è®Šäº† -> é¡¯ç¤ºæ›´æ–°æ‰€æœ‰æª”æ¡ˆ + æ™‚é–“
            MSG="ğŸ”„ åŒæ­¥æ›´æ–°æ‰€æœ‰æª”æ¡ˆ (ğŸ“… $HK_TIME)"
          elif [[ -n "$CHANGED_WORKER" ]]; then
            # åªæœ‰ worker è®Šäº† -> é¡¯ç¤ºæª”å + æ™‚é–“
            MSG="ğŸ”„ è‡ªå‹•åŒæ­¥ _worker.js (ğŸ“… $HK_TIME)"
          elif [[ -n "$CHANGED_WRANGLER" ]]; then
            # åªæœ‰ wrangler è®Šäº† -> é¡¯ç¤ºæª”å + æ™‚é–“
            MSG="ğŸ”„ è‡ªå‹•åŒæ­¥ wrangler.toml (ğŸ“… $HK_TIME)"
          else
            # æ²’è®Šæ›´ (ä¸æœƒæäº¤ï¼Œä½†è¨­å€‹é è¨­å€¼)
            MSG="ğŸ”„ ç„¡è®Šæ›´ (ğŸ“… $HK_TIME)"
          fi

          echo "ç”Ÿæˆçš„ Commit è¨Šæ¯: $MSG"
          
          # å¯«å…¥ç’°å¢ƒè®Šæ•¸
          echo "COMMIT_MSG=$MSG" >> $GITHUB_ENV

      - name: æäº¤æ›´æ–°åˆ°æ‚¨çš„å€‰åº«
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ env.COMMIT_MSG }}
          commit_user_name: GitHub Actions Bot
          commit_user_email: ${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com
