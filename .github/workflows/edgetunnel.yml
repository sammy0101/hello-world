name: Sync edgetunnel Worker

on:
  schedule:
    - cron: "0 16 * * *" # é¦™æ¸¯æ™‚é–“ 00:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: æª¢å‡ºæ‚¨çš„å€‰åº«
        uses: actions/checkout@v4

      - name: è¨­å®šæ™‚é–“è®Šæ•¸
        run: |
          # é å…ˆè¨ˆç®—é¦™æ¸¯æ™‚é–“ä¸¦å­˜å…¥ç’°å¢ƒè®Šæ•¸
          HK_TIME=$(TZ='Asia/Hong_Kong' date +'%Y-%m-%d %H:%M')
          echo "HK_TIME=$HK_TIME" >> $GITHUB_ENV

      # --- æ–°å¢æ­¥é©Ÿï¼šå®‰è£ç°¡ç¹è½‰æ›å·¥å…· ---
      - name: å®‰è£ OpenCC
        run: |
          sudo apt-get update
          sudo apt-get install -y opencc

      - name: ä¸‹è¼‰æª”æ¡ˆä¸¦è½‰æ›ç‚ºç¹é«”
        run: |
          URL_WORKER="https://github.com/cmliu/edgetunnel/raw/refs/heads/main/_worker.js"
          URL_WRANGLER="https://github.com/cmliu/edgetunnel/raw/refs/heads/main/wrangler.toml"
          
          # --- è™•ç† _worker.js ---
          echo "æ­£åœ¨ä¸‹è¼‰ä¸¦è½‰æ› _worker.js ..."
          # 1. ä¸‹è¼‰åˆ°æš«å­˜æª”
          curl -L -o "_worker.js.tmp" "$URL_WORKER"
          # 2. ä½¿ç”¨ OpenCC è½‰ç¹é«” (s2tw.json è¡¨ç¤ºç°¡é«”è½‰è‡ºç£æ­£é«”)
          opencc -i "_worker.js.tmp" -o "_worker.js" -c s2tw.json
          # 3. åˆªé™¤æš«å­˜æª”
          rm "_worker.js.tmp"
          
          # --- è™•ç† wrangler.toml ---
          echo "æ­£åœ¨ä¸‹è¼‰ä¸¦è½‰æ› wrangler.toml ..."
          curl -L -o "wrangler.toml.tmp" "$URL_WRANGLER"
          opencc -i "wrangler.toml.tmp" -o "wrangler.toml" -c s2tw.json
          rm "wrangler.toml.tmp"

      # --- åˆ†é–‹è™•ç†æäº¤ ---

      - name: æäº¤ _worker.js (å¦‚æœæœ‰è®Šæ›´)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # åªé‡å° _worker.js é€²è¡Œæäº¤
          file_pattern: '_worker.js'
          commit_message: "ğŸ”„ è‡ªå‹•åŒæ­¥ _worker.js (ç¹é«”åŒ–) (ğŸ“… ${{ env.HK_TIME }})"
          commit_user_name: GitHub Actions Bot
          commit_user_email: ${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com
          skip_dirty_check: false    # ç¢ºä¿åªåœ¨æª”æ¡ˆæœ‰è®Šå‹•æ™‚æ‰æäº¤
          skip_fetch: true           # å„ªåŒ–é€Ÿåº¦

      - name: æäº¤ wrangler.toml (å¦‚æœæœ‰è®Šæ›´)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # åªé‡å° wrangler.toml é€²è¡Œæäº¤
          file_pattern: 'wrangler.toml'
          commit_message: "ğŸ”„ è‡ªå‹•åŒæ­¥ wrangler.toml (ç¹é«”åŒ–) (ğŸ“… ${{ env.HK_TIME }})"
          commit_user_name: GitHub Actions Bot
          commit_user_email: ${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com
          skip_dirty_check: false
          skip_fetch: true
